<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot é…ç½®ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .account-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .account-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .account-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #495057;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .whitelist-container {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
        }

        .whitelist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .whitelist-item input {
            flex: 1;
            margin-bottom: 0;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e9ecef;
        }

        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .backup-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .backup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
            background: white;
        }

        .backup-info {
            flex: 1;
        }

        .backup-filename {
            font-weight: 500;
            color: #333;
        }

        .backup-meta {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .env-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .env-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .env-item input {
            flex: 1;
            margin-bottom: 0;
        }

        .env-key {
            flex: 1;
        }

        .env-value {
            flex: 2;
        }

        .env-comment {
            flex: 2;
        }

        .env-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .env-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .env-comment-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .env-comment-row input {
            flex: 1;
        }

        .env-comment-label {
            font-size: 12px;
            color: #666;
            min-width: 60px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .icon {
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Discord Bot é…ç½®ç®¡ç†</h1>
            <p>ç®¡ç†å¤šä¸ªDiscordæœºå™¨äººè´¦æˆ·çš„é…ç½®å’Œç™½åå•</p>
        </div>

        <div class="content">
            <div id="message" class="alert" style="display: none;"></div>

            <div class="section">
                <h2 class="section-title">
                    <span class="icon">âš™ï¸</span>
                    ç¯å¢ƒå˜é‡é…ç½® (.env)
                </h2>
                <div id="env-container">
                    <div class="loading">æ­£åœ¨åŠ è½½ç¯å¢ƒå˜é‡...</div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addEnvVar()">
                        <span class="icon">â•</span>
                        æ·»åŠ ç¯å¢ƒå˜é‡
                    </button>
                    <button class="btn btn-success" onclick="saveEnv()">
                        <span class="icon">ğŸ’¾</span>
                        ä¿å­˜ç¯å¢ƒå˜é‡
                    </button>
                    <button class="btn btn-secondary" onclick="loadEnv()">
                        <span class="icon">ğŸ”„</span>
                        é‡æ–°åŠ è½½
                    </button>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">
                    <span class="icon">ğŸ¤–</span>
                    æœºå™¨äººè´¦æˆ·é…ç½®
                </h2>
                <div id="accounts-container">
                    <div class="loading">æ­£åœ¨åŠ è½½é…ç½®...</div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="addAccount()">
                        <span class="icon">â•</span>
                        æ·»åŠ æ–°è´¦æˆ·
                    </button>
                    <button class="btn btn-success" onclick="saveConfig()">
                        <span class="icon">ğŸ’¾</span>
                        ä¿å­˜é…ç½®
                    </button>
                    <button class="btn btn-secondary" onclick="loadConfig()">
                        <span class="icon">ğŸ”„</span>
                        é‡æ–°åŠ è½½
                    </button>
                </div>
            </div>

            <div class="backup-section">
                <h2 class="section-title">
                    <span class="icon">ğŸ“¦</span>
                    é…ç½®å¤‡ä»½ç®¡ç†
                </h2>
                <div id="backups-container">
                    <div class="loading">æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...</div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="loadBackups()">
                        <span class="icon">ğŸ”„</span>
                        åˆ·æ–°å¤‡ä»½åˆ—è¡¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let accounts = [];
        let accountIdCounter = 0;

        let envVars = {};

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadEnv();
            loadConfig();
            loadBackups();
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = `alert alert-${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/accounts');
                if (response.ok) {
                    accounts = await response.json();
                    renderAccounts();
                } else {
                    showMessage('åŠ è½½é…ç½®å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“è´¦æˆ·åˆ—è¡¨
        function renderAccounts() {
            const container = document.getElementById('accounts-container');
            
            if (accounts.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— é…ç½®ï¼Œç‚¹å‡»"æ·»åŠ æ–°è´¦æˆ·"å¼€å§‹é…ç½®</div>';
                return;
            }

            container.innerHTML = accounts.map((account, index) => `
                <div class="account-card" data-index="${index}">
                    <div class="account-header">
                        <div class="account-title">è´¦æˆ· ${index + 1}: ${account.name || 'æœªå‘½å'}</div>
                        <button class="btn btn-danger btn-small" onclick="removeAccount(${index})">
                            <span class="icon">ğŸ—‘ï¸</span>
                            åˆ é™¤
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>æœºå™¨äººåç§°</label>
                            <input type="text" placeholder="ä¾‹å¦‚: jinyue_king" 
                                   value="${account.name || ''}" 
                                   onchange="updateAccount(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>é¢‘é“ID</label>
                            <input type="text" placeholder="ä¾‹å¦‚: 1236263634091380843" 
                                   value="${account.channel_id || ''}" 
                                   onchange="updateAccount(${index}, 'channel_id', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Discord Token</label>
                        <input type="text" placeholder="ä¾‹å¦‚: MTIzNTgwNTY3MTc5OTI2MzI3NA..." 
                               value="${account.token || ''}" 
                               onchange="updateAccount(${index}, 'token', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>ç™½åå•ç”¨æˆ· (ç”¨æˆ·IDåˆ—è¡¨)</label>
                        <div class="whitelist-container">
                            <div id="whitelist-${index}">
                                ${renderWhitelist(account.whitelist_users || [], index)}
                            </div>
                            <button class="btn btn-primary btn-small" onclick="addWhitelistUser(${index})">
                                <span class="icon">â•</span>
                                æ·»åŠ ç”¨æˆ·ID
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“ç™½åå•ç”¨æˆ·åˆ—è¡¨
        function renderWhitelist(whitelistUsers, accountIndex) {
            if (whitelistUsers.length === 0) {
                return '<div class="loading">æš‚æ— ç™½åå•ç”¨æˆ·</div>';
            }
            
            return whitelistUsers.map((userId, userIndex) => `
                <div class="whitelist-item">
                    <input type="text" placeholder="ç”¨æˆ·ID" 
                           value="${userId}" 
                           onchange="updateWhitelistUser(${accountIndex}, ${userIndex}, this.value)">
                    <button class="btn btn-danger btn-small" onclick="removeWhitelistUser(${accountIndex}, ${userIndex})">
                        <span class="icon">ğŸ—‘ï¸</span>
                    </button>
                </div>
            `).join('');
        }

        // æ›´æ–°è´¦æˆ·ä¿¡æ¯
        function updateAccount(index, field, value) {
            if (accounts[index]) {
                accounts[index][field] = value;
            }
        }

        // æ·»åŠ æ–°è´¦æˆ·
        function addAccount() {
            accounts.push({
                token: '',
                channel_id: '',
                name: `bot_${Date.now()}`,
                whitelist_users: []
            });
            renderAccounts();
        }

        // åˆ é™¤è´¦æˆ·
        function removeAccount(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´¦æˆ·é…ç½®å—ï¼Ÿ')) {
                accounts.splice(index, 1);
                renderAccounts();
            }
        }

        // æ·»åŠ ç™½åå•ç”¨æˆ·
        function addWhitelistUser(accountIndex) {
            if (!accounts[accountIndex].whitelist_users) {
                accounts[accountIndex].whitelist_users = [];
            }
            accounts[accountIndex].whitelist_users.push('');
            renderAccounts();
        }

        // æ›´æ–°ç™½åå•ç”¨æˆ·
        function updateWhitelistUser(accountIndex, userIndex, value) {
            if (accounts[accountIndex] && accounts[accountIndex].whitelist_users) {
                accounts[accountIndex].whitelist_users[userIndex] = value;
            }
        }

        // åˆ é™¤ç™½åå•ç”¨æˆ·
        function removeWhitelistUser(accountIndex, userIndex) {
            if (accounts[accountIndex] && accounts[accountIndex].whitelist_users) {
                accounts[accountIndex].whitelist_users.splice(userIndex, 1);
                renderAccounts();
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            try {
                // éªŒè¯é…ç½®
                for (let i = 0; i < accounts.length; i++) {
                    const account = accounts[i];
                    if (!account.token || !account.channel_id || !account.name) {
                        showMessage(`è´¦æˆ· ${i + 1} çš„é…ç½®ä¸å®Œæ•´`, 'error');
                        return;
                    }
                    // è¿‡æ»¤ç©ºçš„ç™½åå•ç”¨æˆ·ID
                    account.whitelist_users = account.whitelist_users.filter(id => id.trim() !== '');
                }

                const response = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(accounts)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message, 'success');
                    loadBackups(); // åˆ·æ–°å¤‡ä»½åˆ—è¡¨
                } else {
                    const error = await response.json();
                    showMessage(error.error, 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½å¤‡ä»½åˆ—è¡¨
        async function loadBackups() {
            try {
                const response = await fetch('/api/backups');
                if (response.ok) {
                    const backups = await response.json();
                    renderBackups(backups);
                } else {
                    document.getElementById('backups-container').innerHTML = '<div class="loading">åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥</div>';
                }
            } catch (error) {
                document.getElementById('backups-container').innerHTML = '<div class="loading">ç½‘ç»œé”™è¯¯</div>';
            }
        }

        // æ¸²æŸ“å¤‡ä»½åˆ—è¡¨
        function renderBackups(backups) {
            const container = document.getElementById('backups-container');
            
            if (backups.length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— å¤‡ä»½æ–‡ä»¶</div>';
                return;
            }

            container.innerHTML = backups.map(backup => `
                <div class="backup-item">
                    <div class="backup-info">
                        <div class="backup-filename">${backup.filename}</div>
                        <div class="backup-meta">
                            ä¿®æ”¹æ—¶é—´: ${backup.modified} | å¤§å°: ${(backup.size / 1024).toFixed(2)} KB
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="restoreBackup('${backup.filename}')">
                        <span class="icon">ğŸ”„</span>
                        æ¢å¤
                    </button>
                </div>
            `).join('');
        }

        // æ¢å¤å¤‡ä»½
        async function restoreBackup(filename) {
            if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ "${filename}" å—ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/restore/${filename}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message, 'success');
                    loadConfig(); // é‡æ–°åŠ è½½é…ç½®
                } else {
                    const error = await response.json();
                    showMessage(error.error, 'error');
                }
            } catch (error) {
                showMessage('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½ç¯å¢ƒå˜é‡
        async function loadEnv() {
            try {
                const response = await fetch('/api/env');
                if (response.ok) {
                    envVars = await response.json();
                    renderEnvVars();
                } else {
                    showMessage('åŠ è½½ç¯å¢ƒå˜é‡å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“ç¯å¢ƒå˜é‡
        function renderEnvVars() {
            const container = document.getElementById('env-container');
            
            if (Object.keys(envVars).length === 0) {
                container.innerHTML = '<div class="env-card"><div class="loading">æš‚æ— ç¯å¢ƒå˜é‡ï¼Œç‚¹å‡»"æ·»åŠ ç¯å¢ƒå˜é‡"å¼€å§‹é…ç½®</div></div>';
                return;
            }

            const envItems = Object.entries(envVars).map(([key, data], index) => {
                // å…¼å®¹æ–°æ—§æ ¼å¼
                const value = typeof data === 'object' ? data.value : data;
                const comment = typeof data === 'object' ? data.comment : '';
                
                return `
                    <div class="env-row">
                        <div class="env-main">
                            <input type="text" placeholder="å˜é‡å" class="env-key" 
                                   value="${key}" 
                                   onchange="updateEnvVar('${key}', this.value, 'key')">
                            <input type="text" placeholder="å˜é‡å€¼" class="env-value" 
                                   value="${value}" 
                                   onchange="updateEnvVar('${key}', this.value, 'value')">
                            <button class="btn btn-danger btn-small" onclick="removeEnvVar('${key}')">
                                <span class="icon">ğŸ—‘ï¸</span>
                            </button>
                        </div>
                        <div class="env-comment-row">
                            <span class="env-comment-label">ä¸­æ–‡æ³¨é‡Š:</span>
                            <input type="text" placeholder="ä¸ºè¿™ä¸ªç¯å¢ƒå˜é‡æ·»åŠ ä¸­æ–‡è¯´æ˜..." class="env-comment" 
                                   value="${comment}" 
                                   onchange="updateEnvVar('${key}', this.value, 'comment')">
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="env-card">
                    <h3 style="margin-bottom: 15px; color: #495057;">ç¯å¢ƒå˜é‡åˆ—è¡¨</h3>
                    ${envItems}
                </div>
            `;
        }

        // æ›´æ–°ç¯å¢ƒå˜é‡
        function updateEnvVar(key, newValue, type) {
            if (!envVars[key]) {
                envVars[key] = { value: '', comment: '' };
            }
            
            if (type === 'key') {
                // æ›´æ–°é”®å
                if (newValue !== key) {
                    const oldData = envVars[key];
                    delete envVars[key];
                    envVars[newValue] = oldData;
                    renderEnvVars();
                }
            } else if (type === 'value') {
                // æ›´æ–°å€¼
                if (typeof envVars[key] === 'object') {
                    envVars[key].value = newValue;
                } else {
                    envVars[key] = { value: newValue, comment: '' };
                }
            } else if (type === 'comment') {
                // æ›´æ–°æ³¨é‡Š
                if (typeof envVars[key] === 'object') {
                    envVars[key].comment = newValue;
                } else {
                    envVars[key] = { value: envVars[key] || '', comment: newValue };
                }
            }
        }

        // æ·»åŠ ç¯å¢ƒå˜é‡
        function addEnvVar() {
            const newKey = `NEW_VAR_${Date.now()}`;
            envVars[newKey] = { value: '', comment: '' };
            renderEnvVars();
        }

        // åˆ é™¤ç¯å¢ƒå˜é‡
        function removeEnvVar(key) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ç¯å¢ƒå˜é‡ "${key}" å—ï¼Ÿ`)) {
                delete envVars[key];
                renderEnvVars();
            }
        }

        // ä¿å­˜ç¯å¢ƒå˜é‡
        async function saveEnv() {
            try {
                // è¿‡æ»¤ç©ºçš„ç¯å¢ƒå˜é‡
                const filteredEnvVars = {};
                for (const [key, data] of Object.entries(envVars)) {
                    const trimmedKey = key.trim();
                    if (trimmedKey !== '') {
                        if (typeof data === 'object') {
                            const trimmedValue = data.value ? data.value.trim() : '';
                            const trimmedComment = data.comment ? data.comment.trim() : '';
                            if (trimmedValue !== '' || trimmedComment !== '') {
                                filteredEnvVars[trimmedKey] = {
                                    value: trimmedValue,
                                    comment: trimmedComment
                                };
                            }
                        } else {
                            // å…¼å®¹æ—§æ ¼å¼
                            const trimmedValue = data.trim();
                            if (trimmedValue !== '') {
                                filteredEnvVars[trimmedKey] = {
                                    value: trimmedValue,
                                    comment: ''
                                };
                            }
                        }
                    }
                }

                const response = await fetch('/api/env', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(filteredEnvVars)
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message, 'success');
                    envVars = filteredEnvVars;
                    renderEnvVars();
                } else {
                    const error = await response.json();
                    showMessage(error.error, 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>